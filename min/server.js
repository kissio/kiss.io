"use strict";function Server(e){return this instanceof Server?(this.engine=null,this.httpServer=null,this.nsps={},this.opts=e||{},this.opts.sioCompatible&&this.makeCompatible(),this.path(this.opts.path||"/io"),void this.origins(this.opts.origins||"*:*")):Server.instance(e)}var debug=require("debug")("kiss.io:server"),http=require("http"),eio=require("engine.io"),url=require("url"),Client=require("./client"),Namespace=require("./namespace"),Socket=require("./socket"),Plugin=require("./plugin"),Router=require("./router");Server.instance=function(e){return Server.singleton||(Server.singleton=new Server(e)),Server.singleton},Server.Server=Server,Server.Namespace=Namespace,Server.Client=Client,Server.Socket=Socket,Server.Plugin=Plugin,Server.Router=Router,Server.prototype.checkRequest=function(e,t){var r=e.headers.origin||e.headers.referer;if("null"!=r&&null!=r||(r="*"),r&&"function"==typeof this._origins)return this._origins(r,t);if(-1!==this._origins.indexOf("*:*"))return t(null,!0);if(r)try{var i=url.parse(r),n="https:"==i.protocol?443:80;i.port=null!=i.port?i.port:n;var s=~this._origins.indexOf(i.hostname+":"+i.port)||~this._origins.indexOf(i.hostname+":*")||~this._origins.indexOf("*:"+i.port);return t(null,!!s)}catch(o){}t(null,!1)},Server.prototype.path=function(e){return arguments.length&&(this._path=e.replace(/\/$/,""),this.opts.path=this._path),this._path},Server.prototype.origins=function(e){return arguments.length&&("function"==typeof e||Array.isArray(e)||(e=[e]),this._origins=e,this.opts.origins=this._origins),this._origins},Server.prototype.makeCompatible=function(){return this.path("/socket.io"),this.opts.sioCompatible=!0,this},Server.createHttpServer=function(e){function t(e,t){t.writeHead(404),t.end()}return http.createServer(e||t)},Server.prototype.attach=Server.prototype.attachHttp=function(e,t){return this.httpServer&&(this.close(),delete this.httpServer),e instanceof http.Server||(e=Server.createHttpServer(e)),t=Object.assign({},this.opts,t||{}),t.path=t.path||this.path(),t.allowRequest=t.allowRequest||this.checkRequest.bind(this),this.httpServer=e,debug("creating engine.io instance with opts %j",t),this.bind(eio.attach(e,t)),this},Server.prototype.listen=function(){return this.httpServer||this.attachHttp(),this.httpServer.listen.apply(this.httpServer,arguments),this},Server.prototype.bind=function(e){return this.engine=e,this.engine.on("connection",this.onConnection.bind(this)),this},Server.prototype.onConnection=function(e){debug("incoming connection with id %s",e.id);var t=new Client(this,e);return this.opts.sioCompatible&&this.nsps["/"]&&t.connect("/"),t},Server.prototype.close=function(){Object.keys(this.nsps).forEach(function(e){var t=this.nsps[e];Object.keys(t.sockets).forEach(function(e){t.socket(e).onClose()})},this),this.engine.close(),this.httpServer&&this.httpServer.close()},Server.prototype.of=Server.prototype.namespace=function(e,t){var r=this.nsps[Namespace.slugify(e)];return r||(debug("initializing namespace %s",e),r=new Namespace(e,t),this.nsps[r.name]=r),r},Server.prototype.use=Server.prototype.mount=function(e,t){return t instanceof Namespace||e instanceof Namespace||debug("Server.mount: nsp must be instance of `Namespace` class!"),1==arguments.length?t=e:2==arguments.length&&(t.name=Namespace.slugify(e)),this.nsps[t.name]=t,this},module.exports=Server;